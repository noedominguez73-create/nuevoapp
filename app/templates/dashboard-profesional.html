<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Principal - completmirror.io</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .font-serif {
            font-family: 'Playfair Display', serif;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>

<body class="bg-gray-50 flex h-screen overflow-hidden text-slate-800">
    <!-- Sidebar Placeholder -->
    <div class="hidden md:flex flex-col w-64 bg-white border-r border-gray-200 h-full p-6">
        <a href="/" class="mb-10 flex items-center gap-2 group">
            <div class="relative">
                <i data-lucide="sparkles" class="h-8 w-8 text-blue-600 group-hover:rotate-12 transition-transform"></i>
            </div>
            <span
                class="text-xl font-serif font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">
                CompletMirror.io
            </span>
        </a>

        <nav class="space-y-2 flex-1">
            <a href="/dashboard-profesional"
                class="flex items-center gap-3 px-4 py-3 bg-blue-50 text-blue-600 rounded-xl font-medium transition-colors">
                <i data-lucide="layout-dashboard" class="h-5 w-5"></i>
                Panel Principal
            </a>
            <a href="/mis-finanzas"
                class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:bg-gray-50 hover:text-gray-900 rounded-xl font-medium transition-colors">
                <i data-lucide="wallet" class="h-5 w-5"></i>
                Mis Finanzas
            </a>
            <a href="/chatbot-config"
                class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:bg-gray-50 hover:text-gray-900 rounded-xl font-medium transition-colors">
                <i data-lucide="bot" class="h-5 w-5"></i>
                Mi Chatbot IA
            </a>
            <a href="/profesionales"
                class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:bg-gray-50 hover:text-gray-900 rounded-xl font-medium transition-colors">
                <i data-lucide="user-circle" class="h-5 w-5"></i>
                Perfil Público
            </a>
            <a href="/mirror"
                class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:bg-gray-50 hover:text-gray-900 rounded-xl font-medium transition-colors">
                <i data-lucide="sparkles" class="h-5 w-5"></i>
                Mirror IA
            </a>
        </nav>

        <div class="mt-auto pt-6 border-t border-gray-100">
            <a href="#profileForm" onclick="document.getElementById('profileForm').scrollIntoView({behavior: 'smooth'})"
                class="flex items-center gap-3 mb-4 hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer group">
                <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold group-hover:bg-blue-600 group-hover:text-white transition-colors"
                    id="userInitials">
                    U
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900 truncate group-hover:text-blue-600" id="userName">
                        Usuario</p>
                    <p class="text-xs text-gray-500 truncate">Mi Perfil</p>
                </div>
            </a>
            <button onclick="logout()"
                class="w-full flex items-center justify-center gap-2 px-4 py-2 border border-red-100 text-red-600 rounded-lg hover:bg-red-50 text-sm font-medium transition-colors">
                <i data-lucide="log-out" class="h-4 w-4"></i>
                Cerrar Sesión
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
        <main class="flex-1 overflow-y-auto p-6 md:p-12 scroll-smooth">
            <div class="max-w-6xl mx-auto space-y-8">

                <!-- Header -->
                <div class="flex justify-between items-end">
                    <div>
                        <h1 class="text-3xl font-serif font-bold text-gray-900">Bienvenido de nuevo</h1>
                        <p class="text-gray-500 mt-2">Aquí tienes el resumen de tu actividad hoy.</p>
                    </div>
                    <a href="/creditos"
                        class="hidden md:flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-full font-medium transition-all shadow-lg hover:shadow-xl hover:-translate-y-0.5">
                        <i data-lucide="plus" class="h-5 w-5"></i>
                        Recargar Saldo
                    </a>
                </div>

                <!-- KPI Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <!-- Rating -->
                    <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                        <div class="flex justify-between items-start mb-4">
                            <span class="text-xs font-bold text-gray-400 uppercase">Calificación</span>
                            <div class="p-2 bg-yellow-50 rounded-full text-yellow-600">
                                <i data-lucide="star" class="h-4 w-4"></i>
                            </div>
                        </div>
                        <div class="flex items-baseline gap-2">
                            <h3 class="text-3xl font-bold text-gray-900" id="statRating">0.0</h3>
                            <span class="text-sm text-gray-500" id="statReviews">(0 reseñas)</span>
                        </div>
                    </div>

                    <!-- Balance -->
                    <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm relative overflow-hidden group hover:border-blue-200 transition-colors cursor-pointer"
                        onclick="window.location.href='/creditos'">
                        <div class="flex justify-between items-start mb-4">
                            <span class="text-xs font-bold text-gray-400 uppercase">Créditos IA</span>
                            <div
                                class="p-2 bg-blue-50 rounded-full text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition-colors">
                                <i data-lucide="zap" class="h-4 w-4"></i>
                            </div>
                        </div>
                        <h3 class="text-3xl font-bold text-gray-900" id="statCredits">0</h3>
                        <p class="text-xs text-blue-500 font-medium mt-1">Disponible</p>
                    </div>

                    <!-- Earnings -->
                    <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                        <div class="flex justify-between items-start mb-4">
                            <span class="text-xs font-bold text-gray-400 uppercase">Ganancias de hoy</span>
                            <div class="p-2 bg-emerald-50 rounded-full text-emerald-600">
                                <i data-lucide="trending-up" class="h-4 w-4"></i>
                            </div>
                        </div>
                        <h3 class="text-3xl font-bold text-gray-900" id="statEarnings">$0.00</h3>
                        <p class="text-xs text-gray-400 mt-1">Ver detalles</p>
                    </div>

                    <!-- Profile Status -->
                    <div class="bg-gradient-to-br from-indigo-500 to-purple-600 p-6 rounded-2xl text-white shadow-lg">
                        <div class="flex justify-between items-start mb-4">
                            <span class="text-xs font-bold text-indigo-100 uppercase">Estado del Perfil</span>
                            <i data-lucide="check-circle" class="h-5 w-5 text-indigo-200"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-1">Activo</h3>
                        <p class="text-xs text-indigo-100 opacity-80">Visible para clientes</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Quick Actions Grid -->
                    <div class="lg:col-span-2 space-y-6">
                        <h2 class="text-xl font-bold text-gray-900">Acciones Rápidas</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <a href="/chatbot-config"
                                class="flex items-center gap-4 p-4 bg-white border border-gray-100 rounded-xl hover:shadow-md transition-all group">
                                <div
                                    class="w-12 h-12 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600 group-hover:scale-110 transition-transform">
                                    <i data-lucide="bot" class="h-6 w-6"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-900">Configurar IA</h3>
                                    <p class="text-sm text-gray-500">Entrena a tu asistente</p>
                                </div>
                            </a>

                            <a href="/mis-finanzas"
                                class="flex items-center gap-4 p-4 bg-white border border-gray-100 rounded-xl hover:shadow-md transition-all group">
                                <div
                                    class="w-12 h-12 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-600 group-hover:scale-110 transition-transform">
                                    <i data-lucide="pie-chart" class="h-6 w-6"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-900">Finanzas</h3>
                                    <p class="text-sm text-gray-500">Ver ingresos y gastos</p>
                                </div>
                            </a>

                            <a href="/referrals"
                                class="flex items-center gap-4 p-4 bg-white border border-gray-100 rounded-xl hover:shadow-md transition-all group">
                                <div
                                    class="w-12 h-12 rounded-full bg-purple-50 flex items-center justify-center text-purple-600 group-hover:scale-110 transition-transform">
                                    <i data-lucide="users" class="h-6 w-6"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-900">Referidos</h3>
                                    <p class="text-sm text-gray-500">Programa de afiliados</p>
                                </div>
                            </a>

                            <a href="/mirror"
                                class="flex items-center gap-4 p-4 bg-white border border-gray-100 rounded-xl hover:shadow-md transition-all group">
                                <div
                                    class="w-12 h-12 rounded-full bg-pink-50 flex items-center justify-center text-pink-600 group-hover:scale-110 transition-transform">
                                    <i data-lucide="sparkles" class="h-6 w-6"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-900">Mirror IA</h3>
                                    <p class="text-sm text-gray-500">Probar cambio de imagen</p>
                                </div>
                            </a>
                        </div>

                        <!-- Profile Form Simplified -->
                        <div class="bg-white rounded-2xl border border-gray-100 p-6 mt-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-bold text-gray-900">Datos del Perfil</h2>
                                <button onclick="toggleEditProfile()"
                                    class="text-sm text-blue-600 font-medium hover:underline">Editar</button>
                            </div>

                            <form id="profileForm" class="space-y-4">
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label
                                            class="block text-xs font-bold text-gray-500 uppercase mb-1">Nombre</label>
                                        <input type="text" id="fullName"
                                            class="w-full bg-gray-50 border-gray-200 rounded-lg text-sm" disabled>
                                    </div>
                                    <div>
                                        <label
                                            class="block text-xs font-bold text-gray-500 uppercase mb-1">Especialidad</label>
                                        <select id="specialty"
                                            class="w-full bg-gray-50 border-gray-200 rounded-lg text-sm" disabled>
                                            <option value="Abogado">Abogado</option>
                                            <option value="Contador">Contador</option>
                                            <option value="Arquitecto">Arquitecto</option>
                                            <option value="Médico">Médico</option>
                                            <option value="Psicólogo">Psicólogo</option>
                                            <option value="Estilista">Estilista</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="editActions" class="hidden justify-end pt-4">
                                    <button type="submit"
                                        class="bg-blue-600 text-white px-6 py-2 rounded-lg text-sm font-bold hover:bg-blue-700 transition">Guardar
                                        Cambios</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Sidebar Right (Activity) -->
                    <div class="space-y-6">
                        <div class="bg-white rounded-2xl border border-gray-100 p-6 shadow-sm h-full">
                            <h2 class="text-xl font-bold text-gray-900 mb-6">Actividad Reciente</h2>
                            <div id="activityContainer" class="space-y-6">
                                <!-- Placeholders -->
                                <div class="flex items-start gap-3">
                                    <div
                                        class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center flex-shrink-0">
                                        <i data-lucide="bell" class="h-4 w-4 text-gray-400"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-800">Inicio de sesión exitoso</p>
                                        <p class="text-xs text-gray-400 mt-1">Hace un momento</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Logic -->
    <script src="/static/js/auth.js"></script>
    <script src="/static/js/api.js"></script>
    <script>
        let professionalId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();

            // Check auth from auth.js if available, or just use localStorage
            const user = getCurrentUser(); // Provided by auth.js
            if (!user) {
                window.location.href = '/login';
                return;
            }
            // const user = JSON.parse(userStr); // Removed redundant parse since getCurrentUser returns object

            document.getElementById('userName').textContent = user.full_name || 'Usuario';
            document.getElementById('userEmail').textContent = user.email || '';
            document.getElementById('userInitials').textContent = user.full_name ? user.full_name.charAt(0).toUpperCase() : 'U';

            await loadDashboardData(user);
        });

        async function loadDashboardData(user) {
            try {
                // Fetch Professional Profile
                const profResult = await apiGet(`/profesionales?user_id=${user.id}`);

                if (profResult.success && profResult.data.professionals && profResult.data.professionals.length > 0) {
                    const prof = profResult.data.professionals[0];
                    professionalId = prof.id;

                    // UI Updates
                    document.getElementById('statRating').textContent = prof.rating ? prof.rating.toFixed(1) : '5.0';
                    document.getElementById('statReviews').textContent = `(${prof.total_reviews || 0} reseñas)`;

                    document.getElementById('fullName').value = prof.full_name;
                    document.getElementById('specialty').value = prof.specialty || 'Abogado';

                    // Load Credits
                    const credResult = await getCredits(professionalId);
                    if (credResult.success) {
                        document.getElementById('statCredits').textContent = credResult.data.available || 0;
                    }

                    // Load Earnings
                    const earnResult = await getReferralEarnings(professionalId);
                    if (earnResult.success) {
                        document.getElementById('statEarnings').textContent = formatCurrency(earnResult.data.available_mxn || 0);
                    }
                }
            } catch (e) {
                console.error("Dashboard Load Error", e);
            }
        }

        function toggleEditProfile() {
            const inputs = document.querySelectorAll('#profileForm input, #profileForm select');
            const actions = document.getElementById('editActions');
            const isDisabled = inputs[0].disabled;

            inputs.forEach(i => {
                i.disabled = !isDisabled;
                if (!isDisabled) i.classList.remove('bg-white'); else i.classList.add('bg-white');
            });

            if (isDisabled) {
                actions.classList.remove('hidden');
                actions.classList.add('flex');
                inputs[0].focus();
            } else {
                actions.classList.add('hidden');
                actions.classList.remove('flex');
            }
        }

        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!professionalId) return;

            const data = {
                full_name: document.getElementById('fullName').value,
                specialty: document.getElementById('specialty').value
            };

            const result = await updateProfessional(professionalId, data);
            if (result.success) {
                alert("Perfil actualizado correctamente");
                toggleEditProfile();
            } else {
                alert("Error al actualizar: " + result.error);
            }
        });

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(amount);
        }
    </script>
    <script src="/static/js/mirror-access-control.js"></script>
</body>

</html>