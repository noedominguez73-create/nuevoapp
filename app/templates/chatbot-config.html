<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuraci√≥n de Chatbot</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Custom Scrollbar for lists */
        #documentsList::-webkit-scrollbar,
        #urlsList::-webkit-scrollbar,
        #testChatMessages::-webkit-scrollbar {
            width: 6px;
        }

        #documentsList::-webkit-scrollbar-track,
        #urlsList::-webkit-scrollbar-track,
        #testChatMessages::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        #documentsList::-webkit-scrollbar-thumb,
        #urlsList::-webkit-scrollbar-thumb,
        #testChatMessages::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        #documentsList::-webkit-scrollbar-thumb:hover,
        #urlsList::-webkit-scrollbar-thumb:hover,
        #testChatMessages::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .drag-over {
            border-color: #2563eb !important;
            background-color: #eff6ff !important;
        }
    </style>
</head>

<body class="bg-gray-100 h-screen overflow-hidden">
    <div class="flex h-full">
        <!-- Sidebar (Inlined) -->
        <aside class="w-64 bg-white border-r h-full flex flex-col hidden md:flex">
            <div class="p-6 border-b flex items-center gap-2">
                <i data-lucide="sparkles" class="h-6 w-6 text-blue-600"></i>
                <h1
                    class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">
                    CompletMirror.io</h1>
            </div>
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <a href="/dashboard-profesional"
                    class="flex items-center gap-3 px-4 py-3 text-slate-600 hover:bg-blue-50 hover:text-blue-600 rounded-xl transition group">
                    <span class="text-xl group-hover:scale-110 transition-transform">üìä</span>
                    <span class="font-medium">Dashboard</span>
                </a>

                <!-- Mis Finanzas Section -->
                <div class="mt-4 mb-2 px-4 text-xs font-bold text-slate-400 uppercase">Mis Finanzas</div>
                <a href="/mis-finanzas"
                    class="flex items-center gap-3 px-4 py-2 text-slate-600 hover:bg-blue-50 hover:text-blue-600 rounded-xl transition group">
                    <span class="text-lg">üè†</span>
                    <span class="font-medium">Inicio</span>
                </a>
                <a href="/mis-finanzas/ingresos"
                    class="flex items-center gap-3 px-4 py-2 text-slate-600 hover:bg-emerald-50 hover:text-emerald-600 rounded-xl transition group">
                    <span class="text-lg">üí∞</span>
                    <span class="font-medium">Bancos</span>
                </a>
                <a href="/mis-finanzas/facturas"
                    class="flex items-center gap-3 px-4 py-2 text-slate-600 hover:bg-rose-50 hover:text-rose-600 rounded-xl transition group">
                    <span class="text-lg">üßæ</span>
                    <span class="font-medium">Gastos</span>
                </a>
                <a href="/mis-finanzas/pagos"
                    class="flex items-center gap-3 px-4 py-2 text-slate-600 hover:bg-orange-50 hover:text-orange-600 rounded-xl transition group">
                    <span class="text-lg">üí≥</span>
                    <span class="font-medium">Pagos</span>
                </a>
                <a href="/mis-finanzas/pendientes"
                    class="flex items-center gap-3 px-4 py-2 text-slate-600 hover:bg-yellow-50 hover:text-yellow-600 rounded-xl transition group">
                    <span class="text-lg">‚è≥</span>
                    <span class="font-medium">Pendientes</span>
                </a>
                <a href="/mis-finanzas/reportes"
                    class="flex items-center gap-3 px-4 py-2 text-slate-600 hover:bg-purple-50 hover:text-purple-600 rounded-xl transition group">
                    <span class="text-lg">üìà</span>
                    <span class="font-medium">Reportes</span>
                </a>

                <div class="border-t border-slate-100 my-2 pt-2">
                    <p class="px-4 text-xs font-bold text-slate-400 uppercase mb-2">Herramientas</p>
                    <a href="/cambio_de_imagen"
                        class="flex items-center gap-3 px-4 py-3 text-slate-600 hover:bg-pink-50 hover:text-pink-600 rounded-xl transition group">
                        <span class="text-xl group-hover:scale-110 transition-transform">üé®</span>
                        <span class="font-medium">Cambio de Imagen</span>
                    </a>
                    <a href="/closet"
                        class="flex items-center gap-3 px-4 py-3 text-slate-600 hover:bg-purple-50 hover:text-purple-600 rounded-xl transition group">
                        <span class="text-xl group-hover:scale-110 transition-transform">üëó</span>
                        <span class="font-medium">Mi Closet IA</span>
                    </a>
                    <a href="/mirror"
                        class="flex items-center gap-3 px-4 py-3 text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 rounded-xl transition group">
                        <span class="text-xl group-hover:scale-110 transition-transform">ü™û</span>
                        <span class="font-medium">Mirror IA</span>
                    </a>
                </div>
            </nav>
            <div class="px-4 py-3 border-t bg-slate-50 flex flex-col gap-2">
                <!-- User Identity Payload -->
                <div id="sidebarUserIdentity"
                    class="flex items-center gap-3 px-2 py-2 mb-1 rounded-lg bg-white border border-slate-100 shadow-sm">
                    <div
                        class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-sm">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p id="sidebarUserName" class="text-sm font-bold text-slate-700 truncate">Usuario</p>
                        <p id="sidebarUserEmail" class="text-xs text-slate-400 truncate">...</p>
                    </div>
                </div>

                <button onclick="logout()"
                    class="w-full px-4 py-2 text-red-600 hover:bg-red-100 rounded-xl transition flex items-center justify-center gap-2 font-medium text-sm">
                    <span>üö™</span> Cerrar Sesi√≥n
                </button>
            </div>

            <script>
                document.addEventListener('DOMContentLoaded', () => {
                    // 1. Populate User Info
                    const userStr = localStorage.getItem('asesoriaimss_user');
                    if (userStr) {
                        const user = JSON.parse(userStr);
                        const nameEl = document.getElementById('sidebarUserName');
                        const emailEl = document.getElementById('sidebarUserEmail');

                        if (nameEl) nameEl.textContent = user.full_name || 'Usuario';
                        if (emailEl) emailEl.textContent = user.email || '';

                        // 2. RESTRICT SALON ACCESS (Redirect Loop Prevention)
                        if (user.is_salon_owner && !window.location.pathname.includes('/mirror')) {
                            // Force redirect back to mirror if they wander off
                            window.location.href = '/mirror';
                        }
                    }
                });
            </script>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="bg-white shadow-sm z-10">
                <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-gray-900">Configuraci√≥n del Chatbot</h1>
                    <div class="flex items-center gap-4">
                        <span class="text-sm text-gray-500" id="headerUserId">Cargando...</span>
                    </div>
                </div>
            </header>

            <!-- Content Scrollable Area -->
            <main class="flex-1 overflow-y-auto p-6">
                <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8">

                    <!-- Left Column: Configuration -->
                    <div class="space-y-6">

                        <!-- General Settings (Inlined) -->
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-lg font-semibold text-gray-800">Configuraci√≥n General</h2>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="isActive" class="sr-only peer">
                                    <div
                                        class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                                    </div>
                                    <span class="ml-3 text-sm font-medium text-gray-700">Activar Chatbot</span>
                                </label>
                            </div>

                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Mensaje de
                                        Bienvenida</label>
                                    <textarea id="welcomeMessage" rows="2"
                                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                        placeholder="Hola, ¬øen qu√© puedo ayudarte hoy?"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Prompt del Sistema
                                        (Instrucciones)</label>
                                    <textarea id="systemPrompt" rows="4"
                                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                        placeholder="Eres un asistente experto en..."></textarea>
                                    <p class="mt-1 text-xs text-gray-500">Define la personalidad y el rol del chatbot.
                                    </p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Base de Conocimiento
                                        (Texto
                                        Directo)</label>
                                    <textarea id="knowledgeBase" rows="4"
                                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                        placeholder="Informaci√≥n clave que el bot debe saber..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Documents Upload (Inlined) -->
                        <div class="bg-white rounded-lg shadow p-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">Documentos de Referencia</h2>

                            <!-- Upload Zone -->
                            <div id="uploadZone"
                                class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 hover:bg-blue-50 transition cursor-pointer mb-4">
                                <input type="file" id="fileInput" class="hidden" multiple
                                    accept=".pdf,.txt,.doc,.docx,.xlsx">
                                <div class="text-gray-500">
                                    <span class="text-4xl block mb-2">üìÑ</span>
                                    <p class="text-sm font-medium">Arrastra archivos aqu√≠ o haz clic para seleccionar
                                    </p>
                                    <p class="text-xs mt-1">PDF, TXT, DOCX, XLSX (Max 10MB)</p>
                                </div>
                            </div>

                            <!-- Pending Files List -->
                            <div id="pendingFilesContainer" class="hidden mb-4">
                                <h3 class="text-sm font-medium text-gray-700 mb-2">Archivos Pendientes:</h3>
                                <div id="pendingFilesList" class="space-y-2 mb-3">
                                    <!-- Pending items injected here -->
                                </div>
                                <button id="btnUploadFiles" onclick="uploadPendingFiles()"
                                    class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md text-sm font-medium transition flex justify-center items-center gap-2">
                                    <span>‚òÅÔ∏è</span> Subir Documentos
                                </button>
                            </div>

                            <!-- Progress Bar -->
                            <div id="uploadProgress" class="hidden mb-4">
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div id="progressFill" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%">
                                    </div>
                                </div>
                                <p class="text-xs text-center text-gray-500 mt-1" id="progressText">0%</p>
                            </div>

                            <!-- Documents List -->
                            <div>
                                <h3 class="text-sm font-medium text-gray-700 mb-2">Documentos Cargados (<span
                                        id="docCount">0</span>)</h3>
                                <div id="documentsList" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                                    <!-- Document Items will be injected here -->
                                    <div id="noDocuments" class="text-center text-gray-400 py-4 text-sm">No hay
                                        documentos cargados</div>
                                </div>
                            </div>
                        </div>

                        <!-- URLs Indexing (Inlined) -->
                        <div class="bg-white rounded-lg shadow p-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">Indexar URLs</h2>
                            <div class="bg-gray-50 p-4 rounded-md mb-4 border border-gray-200">
                                <div class="space-y-3">
                                    <input type="url" id="urlInput" placeholder="https://ejemplo.com/articulo"
                                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                                    <div class="grid grid-cols-2 gap-3">
                                        <input type="text" id="specialtyInput" placeholder="Especialidad (opcional)"
                                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                                        <input type="text" id="descriptionInput" placeholder="Descripci√≥n breve"
                                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                                    </div>
                                    <button id="btnAddUrl"
                                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition text-sm font-medium flex justify-center items-center gap-2">
                                        <span>‚ûï</span> Agregar URL
                                    </button>
                                </div>
                            </div>

                            <div class="mt-4">
                                <h3 class="text-sm font-medium text-gray-700 mb-2">URLs Indexadas (<span
                                        id="urlCount">0</span>)</h3>
                                <div id="urlsList" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                                    <!-- URL Items will be injected here -->
                                    <div id="noUrls" class="text-center text-gray-400 py-4 text-sm">No hay URLs
                                        agregadas</div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Right Column: Test Chatbot (Inlined) -->
                    <div class="flex flex-col h-[calc(100vh-140px)] sticky top-6">
                        <div class="bg-white rounded-lg shadow-lg flex flex-col h-full border border-gray-200">
                            <!-- Chat Header -->
                            <div
                                class="p-4 border-b border-gray-200 bg-gray-50 rounded-t-lg flex justify-between items-center">
                                <div>
                                    <h2 class="text-lg font-bold text-gray-800">Probar Chatbot</h2>
                                    <p class="text-xs text-gray-500">Prueba la configuraci√≥n en tiempo real</p>
                                </div>
                                <button onclick="saveConfig()"
                                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium transition flex items-center gap-2 shadow-sm">
                                    <span>üíæ</span> Guardar Todo
                                </button>
                            </div>

                            <!-- Chat Messages Area -->
                            <div id="testChatMessages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-white">
                                <div class="text-center py-8">
                                    <div class="bg-blue-50 text-blue-800 px-4 py-3 rounded-lg inline-block text-sm">
                                        üëã ¬°Hola! Configura tu chatbot y pru√©balo aqu√≠.
                                        <br>Recuerda <strong>guardar los cambios</strong> antes de probar.
                                    </div>
                                </div>
                            </div>

                            <!-- Chat Input Area -->
                            <div class="p-4 border-t border-gray-200 bg-gray-50 rounded-b-lg">
                                <div class="flex flex-col gap-2">
                                    <!-- Voice Selector Row -->
                                    <div class="flex items-center gap-2">
                                        <label for="voiceSelector"
                                            class="text-xs text-gray-600 whitespace-nowrap">Voz:</label>
                                        <select id="voiceSelector"
                                            class="flex-1 text-sm px-3 py-2 rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500 bg-white"
                                            onchange="handleVoiceChange()" title="Seleccionar voz para respuestas">
                                            <option value="">Detectando voces...</option>
                                        </select>
                                    </div>

                                    <!-- Input and Buttons Row -->
                                    <div class="flex gap-2">
                                        <div class="flex-1 relative">
                                            <input type="text" id="testChatInput"
                                                class="w-full pl-4 pr-10 py-3 rounded-xl border-gray-300 focus:border-blue-500 focus:ring-blue-500 shadow-sm"
                                                placeholder="Escribe un mensaje..."
                                                onkeypress="if(event.key==='Enter') sendTestMessage()">
                                        </div>
                                        <button onclick="sendTestMessage()"
                                            class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-xl transition shadow-sm">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                                            </svg>
                                        </button>
                                        <button onclick="startTestVoiceRecognition()" id="micBtn"
                                            class="bg-gray-200 hover:bg-gray-300 text-gray-700 p-3 rounded-xl transition"
                                            title="Hablar">
                                            üé§
                                        </button>
                                        <button onclick="toggleContinuousConversation()" id="continuousBtn"
                                            class="bg-gray-200 hover:bg-gray-300 text-gray-700 p-3 rounded-xl transition"
                                            title="Modo Conversaci√≥n Continua">
                                            <span class="text-xl font-bold">‚àû</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <!-- Load JS last -->
    <script src="/static/js/chatbot-config.js"></script>
</body>

</html>