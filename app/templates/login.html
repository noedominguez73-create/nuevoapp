<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesi√≥n - CompletMirror.io</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .hero-bg {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
    </style>
</head>

<body class="hero-bg text-gray-800 flex flex-col justify-between">
    <!-- Header -->
    <header class="w-full bg-white/90 backdrop-blur-md shadow-sm transition-all duration-300">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="/"
                class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-[#0066CC] to-[#D946A6] tracking-tight flex items-center gap-2">
                <span>‚ú®</span> CompletMirror.io
            </a>
            <a href="/registro" class="text-sm font-medium text-[#0066CC] hover:underline">¬øNo tienes cuenta?
                Reg√≠strate</a>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="flex-grow flex items-center justify-center px-4 py-12">
        <div
            class="w-full max-w-md bg-white/80 backdrop-blur-xl rounded-2xl shadow-xl border border-white/50 p-8 transform transition-all duration-500 hover:shadow-2xl">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-[#0D1A3B] mb-2">Bienvenido de nuevo</h1>
                <p class="text-gray-500">Ingresa a tu cuenta para gestionar tu estilo.</p>
            </div>

            <!-- Role Selection -->
            <div class="mb-6 bg-gray-100/50 p-1 rounded-xl flex gap-1 overflow-x-auto">
                <button type="button" id="loginUserBtn" onclick="selectLoginRole('user')"
                    class="flex-1 py-2 px-2 text-sm font-semibold rounded-lg transition-all duration-200 text-gray-600 hover:text-gray-900 whitespace-nowrap">
                    Usuario
                </button>
                <button type="button" id="loginSalonBtn" onclick="selectLoginRole('salon')"
                    class="flex-1 py-2 px-2 text-sm font-semibold rounded-lg transition-all duration-200 text-gray-600 hover:text-gray-900 flex items-center justify-center gap-1 whitespace-nowrap">
                    <span>üíá‚Äç‚ôÄÔ∏è</span> Sal√≥n
                </button>
                <button type="button" id="loginProfessionalBtn" onclick="selectLoginRole('professional')"
                    class="flex-1 py-2 px-2 text-sm font-semibold rounded-lg transition-all duration-200 text-gray-600 hover:text-gray-900 whitespace-nowrap">
                    Profesional
                </button>
                <button type="button" id="loginStoreBtn" onclick="selectLoginRole('tienda')"
                    class="flex-1 py-2 px-2 text-sm font-semibold rounded-lg transition-all duration-200 text-gray-600 hover:text-gray-900 flex items-center justify-center gap-1 whitespace-nowrap">
                    <span>üè™</span> Tienda
                </button>
            </div>

            <form id="loginForm" class="space-y-5">
                <!-- Email/Phone -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Correo o
                        Tel√©fono</label>
                    <div class="relative">
                        <i data-lucide="mail" class="absolute left-4 top-3.5 h-5 w-5 text-gray-400"></i>
                        <input type="text" id="email" required
                            class="w-full pl-12 pr-4 py-3 bg-white/50 border border-gray-200 rounded-xl focus:border-[#0066CC] focus:ring-2 focus:ring-blue-100 outline-none transition"
                            placeholder="nombre@ejemplo.com">
                    </div>
                </div>

                <!-- Password -->
                <!-- Password -->
                <div>
                    <label
                        class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Contrase√±a</label>
                    <div class="relative">
                        <i data-lucide="lock" class="absolute left-4 top-3.5 h-5 w-5 text-gray-400"></i>
                        <input type="password" id="password" required
                            class="w-full pl-12 pr-12 py-3 bg-white/50 border border-gray-200 rounded-xl focus:border-[#0066CC] focus:ring-2 focus:ring-blue-100 outline-none transition"
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        <button type="button" onclick="togglePasswordVisibility()"
                            class="absolute right-4 top-3.5 text-gray-400 hover:text-[#0066CC] transition focus:outline-none">
                            <i id="eyeIcon" data-lucide="eye" class="h-5 w-5"></i>
                        </button>
                    </div>
                </div>

                <script>
                    function togglePasswordVisibility() {
                        const passwordInput = document.getElementById('password');
                        const eyeIcon = document.getElementById('eyeIcon');

                        if (passwordInput.type === 'password') {
                            passwordInput.type = 'text';
                            eyeIcon.setAttribute('data-lucide', 'eye-off');
                        } else {
                            passwordInput.type = 'password';
                            eyeIcon.setAttribute('data-lucide', 'eye');
                        }
                        lucide.createIcons();
                    }
                </script>

                <!-- Remember & Forgot -->
                <div class="flex items-center justify-between text-sm">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="remember"
                            class="w-4 h-4 text-[#0066CC] rounded border-gray-300 focus:ring-blue-500">
                        <span class="ml-2 text-gray-600">Recordarme</span>
                    </label>
                    <a href="#" class="text-[#0066CC] hover:underline font-medium hover:text-[#0055aa]">Recuperar
                        clave</a>
                </div>

                <!-- Submit Button -->
                <button type="submit" id="submitBtn"
                    class="w-full py-3.5 bg-gradient-to-r from-[#0066CC] to-[#0055aa] text-white rounded-xl font-bold shadow-lg shadow-blue-500/30 hover:shadow-blue-500/50 hover:-translate-y-0.5 transition-all duration-200">
                    Iniciar Sesi√≥n
                </button>
            </form>

            <!-- Divider -->
            <div class="mt-8 relative flex items-center justify-center">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-200"></div>
                </div>
                <div class="relative bg-white/0 px-4">
                    <span class="text-xs text-gray-400 bg-white/80 px-2 rounded-full backdrop-blur-sm">O contin√∫a
                        con</span>
                </div>
            </div>

            <!-- Social Login -->
            <div class="mt-6 grid grid-cols-2 gap-3">
                <button onclick="loginWithGoogleOAuth()"
                    class="px-4 py-2.5 bg-white border border-gray-200 rounded-xl hover:bg-gray-50 transition flex items-center justify-center gap-2 font-medium text-gray-700 text-sm shadow-sm">
                    <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5" alt="Google">
                    Google
                </button>
                <button onclick="loginWithFacebookOAuth()"
                    class="px-4 py-2.5 bg-white border border-gray-200 rounded-xl hover:bg-gray-50 transition flex items-center justify-center gap-2 font-medium text-gray-700 text-sm shadow-sm">
                    <img src="https://www.svgrepo.com/show/475647/facebook-color.svg" class="w-5 h-5" alt="Facebook">
                    Facebook
                </button>
            </div>
        </div>
    </main>

    <footer class="text-center py-6 text-xs text-gray-500">
        &copy; 2025 completmirror.io - Todos los derechos reservados
    </footer>

    <script src="/static/js/auth.js"></script>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/components.js"></script>
    <script>
        lucide.createIcons();

        // --- Role Selection Logic ---
        let selectedRole = 'user';

        // Styles for active/inactive role buttons
        const activeRoleClass = ['bg-white', 'text-[#0066CC]', 'shadow-sm', 'border', 'border-gray-200'];
        const inactiveRoleClass = ['text-gray-500', 'hover:bg-white/50'];

        function selectLoginRole(role) {
            selectedRole = role;
            const roles = ['user', 'salon', 'professional', 'tienda'];

            roles.forEach(r => {
                const btnId = r === 'tienda' ? 'loginStoreBtn' :
                    r === 'salon' ? 'loginSalonBtn' :
                        `login${r.charAt(0).toUpperCase() + r.slice(1)}Btn`;

                const btn = document.getElementById(btnId);
                if (r === role) {
                    btn.classList.add(...activeRoleClass);
                    btn.classList.remove(...inactiveRoleClass);
                } else {
                    btn.classList.remove(...activeRoleClass);
                    btn.classList.add(...inactiveRoleClass);
                }
            });
        }

        // Initialize from URL or default
        const urlParams = new URLSearchParams(window.location.search);
        const roleParam = urlParams.get('role');
        if (roleParam && ['user', 'salon', 'professional', 'tienda'].includes(roleParam)) {
            selectLoginRole(roleParam);
        } else {
            selectLoginRole('user');
        }

        // --- Auth Check ---
        if (isAuthenticated()) {
            const currentUser = getCurrentUser();

            // Allow sloppy match for salon
            let isRoleMatch = false;

            // Allow override logic where if we are expecting 'salon' and get 'user' with flag
            if (roleParam === 'salon' && currentUser.role === 'user' && currentUser.is_salon_owner) {
                isRoleMatch = true;
            } else if (roleParam && currentUser.role === roleParam) {
                isRoleMatch = true;
            } else if (!roleParam) {
                isRoleMatch = true; // Default to success if no param forced
            }

            if (roleParam && !isRoleMatch) {
                logout();
                // Toast logic ideally exists in auth.js or components.js
            } else {
                // Replace form with 'Already Logged In' view
                const container = document.querySelector('.max-w-md');
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div class="w-20 h-20 bg-gradient-to-tr from-[#0066CC] to-[#D946A6] rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-500/30 text-white text-4xl animate-bounce">
                            üëã
                        </div>
                        <h2 class="text-2xl font-bold text-[#0D1A3B] mb-2">¬°Hola, ${currentUser.full_name || 'Usuario'}!</h2>
                        <p class="text-gray-500 mb-8 bg-white/50 py-2 px-4 rounded-lg inline-block backdrop-blur-sm">
                            Sesi√≥n activa como <span class="font-bold text-[#0066CC] uppercase">${currentUser.is_salon_owner && currentUser.role === 'user' ? 'SAL√ìN' : currentUser.role}</span>
                        </p>
                        
                        <div class="space-y-3">
                            <button onclick="redirectToDashboard()" class="w-full py-3.5 bg-[#0066CC] text-white rounded-xl font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-500/20 transform hover:-translate-y-1">
                                Ir al Dashboard üöÄ
                            </button>
                            <button onclick="logout()" class="w-full py-3.5 bg-white border border-gray-200 text-red-500 rounded-xl font-semibold hover:bg-red-50 transition">
                                Cerrar Sesi√≥n
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // --- Login Submission ---
        const loginForm = document.getElementById('loginForm');
        if (loginForm) {
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value.trim();
                const submitBtn = document.getElementById('submitBtn');

                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="animate-pulse">Iniciando...</span>';

                const result = await login(email, password);

                if (result.success) {
                    if (result.user.role === 'admin') {
                        window.location.href = '/admin';
                        return;
                    }

                    // Smart Role Validation
                    let isValidRole = false;
                    if (selectedRole === 'salon') {
                        // Expecting a user role BUT must be salon owner
                        if (result.user.role === 'user' && result.user.is_salon_owner) {
                            isValidRole = true;
                        } else if (result.user.role === 'user' && !result.user.is_salon_owner) {
                            showToast('Esta cuenta es de Usuario normal, no de Sal√≥n.', 'warning');
                            isValidRole = false;
                        } else {
                            isValidRole = false;
                        }
                    } else {
                        // Normal matching with flexibility
                        // If attempting to log in as 'user' but account is 'professional', allow it?
                        // Usually yes, a pro is also a user.
                        if (selectedRole === 'user' && (result.user.role === 'user' || result.user.role === 'professional')) {
                            isValidRole = true;
                        } else {
                            isValidRole = (result.user.role === selectedRole);
                        }

                        // Special case: Allow salon owners to log in as users without error
                        if (selectedRole === 'user' && result.user.role === 'user') {
                            isValidRole = true;
                        }
                    }

                    if (!isValidRole) {
                        showToast(`Esta cuenta es de tipo "${result.user.role}". Verifica tu selecci√≥n.`, 'error');
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Iniciar Sesi√≥n';
                        // Force logout to clean state
                        logout();
                        return;
                    }

                    const redirect = new URLSearchParams(window.location.search).get('redirect');
                    if (redirect) {
                        window.location.href = redirect;
                    } else if (result.user.is_salon_owner) {
                        window.location.href = '/mirror';
                    } else if (result.user.role === 'professional') {
                        window.location.href = '/dashboard-profesional';
                    } else {
                        window.location.href = '/mis-finanzas'; // Default landing
                    }
                } else {
                    showToast(result.error || 'Credenciales inv√°lidas', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Iniciar Sesi√≥n';
                }
            });
        }

        function loginWithGoogleOAuth() { showToast('Pr√≥ximamente', 'info'); }
        function loginWithFacebookOAuth() { showToast('Pr√≥ximamente', 'info'); }
    </script>
</body>

</html>