<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci贸n | Mirror IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FAFAFA;
        }

        h1,
        h2,
        h3,
        .font-serif {
            font-family: 'Playfair Display', serif;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .custom-scrollbar::-webkit-scrollbar {
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
    </style>
</head>

<body class="text-gray-800">

    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="hidden md:flex flex-col w-64 bg-white border-r border-gray-100 h-full fixed left-0 top-0 z-10">
            <div class="p-8">
                <a href="#"
                    class="block text-2xl font-serif font-bold text-blue-600 tracking-tight mb-1">CompletMirror.io</a>
            </div>
            <nav class="flex-1 px-4 space-y-2 overflow-y-auto">
                <a href="#" onclick="location.reload()"
                    class="flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl bg-blue-50 text-blue-600 transition-all">
                    <i data-lucide="layout-dashboard" class="h-5 w-5"></i> Dashboard
                </a>
                <div class="pt-4 pb-2 px-4 text-xs font-bold text-gray-400 uppercase tracking-wider">Mis Finanzas</div>
                <a href="/"
                    class="flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-gray-600 hover:bg-gray-50 transition-all">
                    <i data-lucide="home" class="h-5 w-5 text-orange-500"></i> Inicio
                </a>
                <a href="#"
                    class="flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-gray-600 hover:bg-gray-50 transition-all">
                    <i data-lucide="landmark" class="h-5 w-5 text-amber-500"></i> Bancos
                </a>
                <a href="#"
                    class="flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-gray-600 hover:bg-gray-50 transition-all">
                    <i data-lucide="receipt" class="h-5 w-5 text-purple-400"></i> Gastos
                </a>
                <a href="#"
                    class="flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-gray-600 hover:bg-gray-50 transition-all">
                    <i data-lucide="credit-card" class="h-5 w-5 text-blue-400"></i> Pagos
                </a>
                <a href="#"
                    class="flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-gray-600 hover:bg-gray-50 transition-all">
                    <i data-lucide="hourglass" class="h-5 w-5 text-amber-500"></i> Pendientes
                </a>
                <a href="#"
                    class="flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-gray-600 hover:bg-gray-50 transition-all">
                    <i data-lucide="bar-chart-3" class="h-5 w-5 text-indigo-400"></i> Reportes
                </a>

                <!-- Control de IA - Solo visible para admin@imagina.ia -->
                <a href="/control-ia" id="controlIALink"
                    class="hidden flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-gray-600 hover:bg-gray-50 transition-all">
                    <i data-lucide="brain" class="h-5 w-5 text-purple-500"></i> Control de IA
                </a>
            </nav>
            <div class="p-4 border-t border-gray-100">
                <div class="flex items-center gap-3 p-3 rounded-xl bg-gray-50">
                    <div
                        class="h-10 w-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold">
                        A</div>
                    <div class="overflow-hidden">
                        <p class="text-sm font-bold text-gray-900 truncate">Admin Mirror</p>
                        <p class="text-xs text-gray-500 truncate">admin@imagina.ia</p>
                    </div>
                </div>
                <button onclick="logout()"
                    class="mt-4 w-full flex items-center justify-center gap-2 text-rose-500 text-xs font-bold hover:text-rose-700 transition">
                    <span class="w-1 h-4 bg-rose-500 rounded-full"></span> Cerrar Sesi贸n
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 md:ml-64 h-full overflow-y-auto bg-[#FAFAFA]">
            <div class="p-8 max-w-7xl mx-auto">
                <div class="flex justify-between items-end mb-8">
                    <div>
                        <h1 class="font-serif text-3xl text-gray-900 font-bold mb-2">Panel de Administraci贸n</h1>
                        <p class="text-gray-500">Gesti贸n global de la plataforma.</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <span id="adminNameDisplay" class="text-gray-700 font-medium"></span>
                    </div>
                </div>

                <!-- Stats Dashboard -->
                <div class="grid md:grid-cols-4 gap-6 mb-8">
                    <!-- Total Users -->
                    <div onclick="switchTab('users'); document.getElementById('userRoleFilter').value='all'; loadUsers();"
                        class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100 hover:shadow-md transition-all cursor-pointer group">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-2">Total Usuarios
                                </p>
                                <p id="statUsers"
                                    class="text-3xl font-serif font-bold text-blue-600 group-hover:scale-105 transition-transform origin-left">
                                    0</p>
                            </div>
                            <div
                                class="h-12 w-12 bg-blue-50 text-blue-500 rounded-full flex items-center justify-center">
                                <i data-lucide="users" class="h-6 w-6"></i>
                            </div>
                        </div>
                    </div>
                    <!-- Professionals -->
                    <div onclick="switchTab('users'); document.getElementById('userRoleFilter').value='professional'; loadUsers();"
                        class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100 hover:shadow-md transition-all cursor-pointer group">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-2">Profesionales
                                </p>
                                <p id="statProfessionals"
                                    class="text-3xl font-serif font-bold text-emerald-600 group-hover:scale-105 transition-transform origin-left">
                                    0</p>
                            </div>
                            <div
                                class="h-12 w-12 bg-emerald-50 text-emerald-500 rounded-full flex items-center justify-center">
                                <i data-lucide="star" class="h-6 w-6"></i>
                            </div>
                        </div>
                    </div>
                    <!-- Validations -->
                    <div onclick="switchTab('validations')"
                        class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100 hover:shadow-md transition-all cursor-pointer group">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-2">Validaciones
                                </p>
                                <p id="statPending"
                                    class="text-3xl font-serif font-bold text-amber-500 group-hover:scale-105 transition-transform origin-left">
                                    0</p>
                            </div>
                            <div
                                class="h-12 w-12 bg-amber-50 text-amber-500 rounded-full flex items-center justify-center">
                                <i data-lucide="check-circle" class="h-6 w-6"></i>
                            </div>
                        </div>
                    </div>
                    <!-- Revenue -->
                    <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-2">Ingresos</p>
                                <p id="statRevenue" class="text-3xl font-serif font-bold text-purple-600">$0</p>
                            </div>
                            <div
                                class="h-12 w-12 bg-purple-50 text-purple-500 rounded-full flex items-center justify-center">
                                <i data-lucide="dollar-sign" class="h-6 w-6"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabs Navigation -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-8">
                    <div class="flex overflow-x-auto custom-scrollbar">
                        <button id="tabUsers" onclick="switchTab('users')"
                            class="tab-btn px-6 py-4 text-sm font-semibold text-gray-600 hover:bg-gray-50 border-b-2 border-transparent transition-all whitespace-nowrap">Usuarios</button>
                        <button id="tabSalons" onclick="switchTab('salons')"
                            class="tab-btn px-6 py-4 text-sm font-semibold text-gray-600 hover:bg-gray-50 border-b-2 border-transparent transition-all whitespace-nowrap">Salones</button>
                        <button id="tabShops" onclick="switchTab('shops')"
                            class="tab-btn px-6 py-4 text-sm font-semibold text-gray-600 hover:bg-gray-50 border-b-2 border-transparent transition-all whitespace-nowrap">Tiendas</button>
                        <button id="tabComments" onclick="switchTab('comments')"
                            class="tab-btn px-6 py-4 text-sm font-semibold text-gray-600 hover:bg-gray-50 border-b-2 border-transparent transition-all whitespace-nowrap">Comentarios</button>
                        <button id="tabCredits" onclick="switchTab('credits')"
                            class="tab-btn px-6 py-4 text-sm font-semibold text-gray-600 hover:bg-gray-50 border-b-2 border-transparent transition-all whitespace-nowrap">Agregar
                            Cr茅ditos</button>
                        <button id="tabValidations" onclick="switchTab('validations')"
                            class="tab-btn px-6 py-4 text-sm font-semibold text-gray-600 hover:bg-gray-50 border-b-2 border-transparent transition-all whitespace-nowrap">Validaciones</button>
                        <button id="tabSpecialties" onclick="switchTab('specialties')"
                            class="tab-btn px-6 py-4 text-sm font-semibold text-gray-600 hover:bg-gray-50 border-b-2 border-transparent transition-all whitespace-nowrap">Especialidades</button>
                    </div>
                </div>

                <!-- SECTIONS -->

                <!-- Users Section -->
                <div id="usersSection"
                    class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100 animate-fade-in hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="font-serif text-2xl font-bold text-gray-900">Gesti贸n de Usuarios</h2>
                        <select id="userRoleFilter" onchange="loadUsers()"
                            class="px-4 py-2 border border-gray-200 rounded-xl text-sm focus:border-blue-500 outline-none">
                            <option value="all">Todos los Roles</option>
                            <option value="user">Usuarios</option>
                            <option value="professional">Profesionales</option>
                            <option value="salon">Salones</option>
                            <option value="admin">Administradores</option>
                        </select>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="border-b border-gray-100">
                                    <th class="pb-4 text-xs font-bold text-gray-400 uppercase tracking-wider">Usuario
                                    </th>
                                    <th class="pb-4 text-xs font-bold text-gray-400 uppercase tracking-wider">Rol</th>
                                    <th class="pb-4 text-xs font-bold text-gray-400 uppercase tracking-wider">Estado
                                    </th>
                                    <th class="pb-4 text-xs font-bold text-gray-400 uppercase tracking-wider">Quota</th>
                                    <th
                                        class="pb-4 text-xs font-bold text-gray-400 uppercase tracking-wider text-right">
                                        Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- JS Injected -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Salons Section -->
                <div id="salonsTab" class="hidden animate-fade-in">
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="font-serif text-2xl font-bold text-gray-900">Salones Registrados</h2>
                        <button onclick="openSalonModal()"
                            class="bg-blue-600 text-white px-6 py-2 rounded-xl text-sm font-semibold hover:bg-blue-700 transition shadow-lg shadow-blue-200">
                            + Nuevo Sal贸n
                        </button>
                    </div>
                    <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100 overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="border-b border-gray-100">
                                    <th class="pb-4 text-xs font-bold text-gray-400 uppercase tracking-wider">Sal贸n</th>
                                    <th class="pb-4 text-xs font-bold text-gray-400 uppercase tracking-wider">Cliente
                                    </th>
                                    <th class="pb-4 text-xs font-bold text-gray-400 uppercase tracking-wider">Ciudad
                                    </th>
                                    <th class="pb-4 text-xs font-bold text-gray-400 uppercase tracking-wider">Tokens
                                    </th>
                                    <th
                                        class="pb-4 text-xs font-bold text-gray-400 uppercase tracking-wider text-right">
                                        Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="salonsTableBody">
                                <!-- JS Injected -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Other Sections Placeholders -->
                <div id="shopsTab" class="hidden p-12 text-center text-gray-400">Pr贸ximamente: Gesti贸n de Tiendas</div>
                <div id="commentsSection" class="hidden p-6">
                    <div id="commentsContainer" class="space-y-4"></div>
                </div>
                <div id="creditsSection"
                    class="hidden bg-white rounded-3xl p-8 max-w-2xl mx-auto shadow-sm border border-gray-100">
                    <h2 class="font-serif text-2xl font-bold text-gray-900 mb-6">Agregar Cr茅ditos Manualmente</h2>
                    <form id="creditsForm" class="space-y-6">
                        <!-- Professional Search -->
                        <div class="relative">
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Buscar
                                Profesional</label>
                            <input type="text" id="searchProfessional" placeholder="Nombre o Email..."
                                class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-blue-500 outline-none">
                            <div id="searchResults"
                                class="absolute w-full bg-white mt-1 rounded-xl shadow-xl border border-gray-100 max-h-48 overflow-y-auto hidden z-20">
                            </div>
                            <input type="hidden" id="professionalId" required>
                            <p id="selectedProfessionalName" class="mt-2 text-sm font-bold text-blue-600"></p>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Cantidad
                                de Cr茅ditos</label>
                            <input type="number" id="creditAmount" required min="1"
                                class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Motivo /
                                Referencia</label>
                            <input type="text" id="creditReason" required
                                placeholder="Ej. Bonificaci贸n, Pago Efectivo..."
                                class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-blue-500 outline-none">
                        </div>
                        <button type="submit"
                            class="w-full bg-emerald-500 text-white font-bold py-4 rounded-xl hover:bg-emerald-600 transition shadow-lg shadow-emerald-200">
                            Agregar Cr茅ditos
                        </button>
                    </form>
                </div>
                <div id="validationsSection" class="hidden space-y-4">
                    <div id="transactionsContainer" class="space-y-4"></div>
                </div>
                <div id="specialtiesSection"
                    class="hidden bg-white rounded-3xl p-8 max-w-xl mx-auto shadow-sm border border-gray-100">
                    <h2 class="font-serif text-2xl font-bold text-gray-900 mb-6">Especialidades</h2>
                    <div class="flex gap-2 mb-6">
                        <input type="text" id="newSpecialtyInput" placeholder="Nueva Especialidad"
                            class="flex-1 px-4 py-3 rounded-xl border border-gray-200 focus:border-blue-500 outline-none">
                        <button onclick="addSpecialtyWrapper()"
                            class="bg-blue-600 text-white px-6 rounded-xl font-bold hover:bg-blue-700 transition">Agregar</button>
                    </div>
                    <div id="specialtiesList" class="space-y-2"></div>
                </div>

            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Salon Modal -->
    <div id="salonModal"
        class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div
            class="bg-white rounded-3xl p-8 max-w-lg w-full mx-4 shadow-2xl animate-fade-in relative max-h-[90vh] overflow-y-auto custom-scrollbar">
            <button onclick="closeSalonModal()" class="absolute top-6 right-6 text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="h-6 w-6"></i>
            </button>
            <h3 class="font-serif text-2xl font-bold text-gray-900 mb-6">Nuevo Sal贸n</h3>
            <form id="salonForm" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Email o
                        Tel茅fono</label>
                    <div class="flex gap-2">
                        <select id="salonPhoneCode"
                            class="w-1/3 px-3 py-3 rounded-xl border border-gray-200 bg-gray-50 text-sm">
                            <option value="+52">拆 (+52)</option>
                        </select>
                        <input type="text" id="salonClientIdentifier" required placeholder="email@ejemplo.com"
                            class="w-2/3 px-4 py-3 rounded-xl border border-gray-200 outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Nombre
                        Cliente</label>
                    <input type="text" id="salonClientName" required
                        class="w-full px-4 py-3 rounded-xl border border-gray-200 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Nombre
                        Sal贸n</label>
                    <input type="text" id="salonName" required
                        class="w-full px-4 py-3 rounded-xl border border-gray-200 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Direcci贸n</label>
                    <textarea id="salonAddress" required rows="2"
                        class="w-full px-4 py-3 rounded-xl border border-gray-200 outline-none"></textarea>
                </div>
                <!-- Location Selects -->
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Pa铆s</label>
                        <select id="salonCountry" required
                            class="w-full px-4 py-3 rounded-xl border border-gray-200 outline-none">
                            <option value="">Cargando...</option>
                        </select>
                    </div>
                    <div>
                        <label
                            class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Estado</label>
                        <select id="salonState" required
                            class="w-full px-4 py-3 rounded-xl border border-gray-200 outline-none">
                            <option value="">...</option>
                        </select>
                    </div>
                    <div>
                        <label
                            class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Ciudad</label>
                        <select id="salonCity" required
                            class="w-full px-4 py-3 rounded-xl border border-gray-200 outline-none">
                            <option value="">...</option>
                        </select>
                    </div>
                </div>
                <!-- Password Field -->
                <div class="mb-4 bg-yellow-50 p-4 rounded-xl border border-yellow-100">
                    <label class="block text-xs font-bold text-yellow-700 uppercase tracking-wider mb-2">Contrase帽a
                        (Opcional)</label>
                    <input type="text" id="salonPassword" placeholder="Dejar vac铆o para usar default"
                        class="w-full px-4 py-3 rounded-xl border border-yellow-200 focus:border-yellow-500 outline-none bg-white">
                    <p class="text-xs text-yellow-600 mt-1">Si dejas vac铆o: <code class="font-bold">102o3o4o</code></p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div><label
                            class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Inicio</label><input
                            type="date" id="salonStartDate" required
                            class="w-full px-4 py-3 rounded-xl border border-gray-200 outline-none"></div>
                    <div><label
                            class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Cobro</label><input
                            type="date" id="salonPaymentDate" required
                            class="w-full px-4 py-3 rounded-xl border border-gray-200 outline-none"></div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Tokens</label>
                    <input type="number" id="salonTokens" value="0"
                        class="w-full px-4 py-3 rounded-xl border border-gray-200 outline-none">
                </div>
                <button type="submit"
                    class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl hover:bg-blue-700 transition">Crear
                    Sal贸n</button>
            </form>
        </div>
    </div>


    <script src="/static/js/auth.js?v=new2"></script>
    <script src="/static/js/api.js?v=new2"></script>
    <script src="/static/js/components.js?v=new2"></script>
    <script>
        // Init
        document.addEventListener('DOMContentLoaded', async () => {
            const user = await checkAuth('admin');
            if (document.getElementById('adminNameDisplay')) document.getElementById('adminNameDisplay').textContent = user.full_name;

            lucide.createIcons();

            // Show "Control de IA" button ONLY for admin@imagina.ia
            if (user.email === 'admin@imagina.ia') {
                const controlIALink = document.getElementById('controlIALink');
                if (controlIALink) {
                    controlIALink.classList.remove('hidden');
                }
            }

            // Initial Loads
            loadDashboard();
            loadUsers(); // Load visible tab data

            populateCountries('salonCountry');

            // Default Tab
            switchTab('users');

            // Search Listener
            const searchInput = document.getElementById('searchProfessional');
            if (searchInput) {
                searchInput.addEventListener('input', handleSearch);
            }
        });

        // Tab Switching Logic
        function switchTab(tabName) {
            // Update Buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.className = 'tab-btn px-6 py-4 text-sm font-semibold text-gray-600 hover:bg-gray-50 border-b-2 border-transparent transition-all whitespace-nowrap';
            });
            const active = document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
            if (active) active.className = 'tab-btn px-6 py-4 text-sm font-bold text-blue-600 border-b-2 border-blue-600 bg-blue-50/50 transition-all whitespace-nowrap';

            // Hide Sections
            const maps = {
                'users': 'usersSection',
                'salons': 'salonsTab',
                'shops': 'shopsTab',
                'comments': 'commentsSection',
                'credits': 'creditsSection',
                'validations': 'validationsSection',
                'specialties': 'specialtiesSection'
            };

            Object.values(maps).forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });

            // Show Target
            const target = document.getElementById(maps[tabName]);
            if (target) target.classList.remove('hidden');

            // Load Data
            if (tabName === 'salons') loadSalons();
            if (tabName === 'comments') loadPendingComments();
            if (tabName === 'validations') loadPendingTransactions();
            if (tabName === 'specialties') loadSpecialties();
        }

        // --- Data Loading Functions ---

        async function loadDashboard() {
            const res = await apiGet('/admin/dashboard');
            if (res.success) {
                document.getElementById('statUsers').textContent = res.data.total_users || 0;
                document.getElementById('statProfessionals').textContent = res.data.total_professionals || 0;
                // document.getElementById('statRevenue').textContent = formatCurrency(res.data.income || 0);
            }
        }

        async function loadUsers() {
            const role = document.getElementById('userRoleFilter').value;
            const res = await apiGet(`/admin/usuarios?role=${role === 'all' ? '' : role}`);
            const tbody = document.getElementById('usersTableBody');

            if (res.success && res.data.users) {
                tbody.innerHTML = res.data.users.map(u => `
                    <tr class="border-b border-gray-50 hover:bg-gray-50">
                        <td class="py-4">
                            <div class="flex flex-col"><span class="font-medium text-gray-900">${u.full_name}</span><span class="text-xs text-gray-500">${u.email}</span></div>
                        </td>
                        <td class="py-4"><span class="px-2 py-1 bg-blue-50 text-blue-600 rounded text-xs font-bold capitalize">${u.role}</span></td>
                        <td class="py-4"><span class="px-2 py-1 bg-gray-100 rounded text-xs font-bold">${u.subscription_status || 'inactivo'}</span></td>
                         <td class="py-4 text-xs">${u.current_month_tokens} / ${u.monthly_token_limit}</td>
                        <td class="py-4 text-right">
                             <button onclick="deleteUser(${u.id})" class="text-rose-500 hover:bg-rose-50 p-2 rounded"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
                        </td>
                    </tr>
                 `).join('');
                lucide.createIcons();
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="py-8 text-center text-gray-400">No hay usuarios</td></tr>';
            }
        }

        async function loadSalons() {
            const res = await apiGet('/admin/salones');
            const tbody = document.getElementById('salonsTableBody');
            if (res.success && res.data.salons) {
                tbody.innerHTML = res.data.salons.map(s => `
                    <tr class="border-b border-gray-50 hover:bg-gray-50">
                        <td class="py-4 font-bold text-gray-900">${s.salon_name}</td>
                        <td class="py-4 text-sm text-gray-600">${s.client_name}<br><span class="text-xs text-gray-400">${s.email}</span></td>
                        <td class="py-4 text-sm text-gray-600">${s.city}</td>
                        <td class="py-4 text-sm font-mono">${s.tokens_consumed}</td>
                        <td class="py-4 text-right">
                             <button onclick="deleteSalon(${s.id})" class="text-rose-500 hover:bg-rose-50 p-2 rounded"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
                        </td>
                    </tr>
                 `).join('');
                lucide.createIcons();
            }
        }

        // --- Form Handlers ---

        function openSalonModal() { document.getElementById('salonModal').classList.remove('hidden'); }
        function closeSalonModal() { document.getElementById('salonModal').classList.add('hidden'); }

        document.getElementById('salonForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            // Data Gathering
            let identifier = document.getElementById('salonClientIdentifier').value.trim();
            // If phone logic here...

            const data = {
                client_identifier: identifier,
                client_name: document.getElementById('salonClientName').value,
                salon_name: document.getElementById('salonName').value,
                address: document.getElementById('salonAddress').value,
                city: document.getElementById('salonCity').value,
                state: document.getElementById('salonState').value,
                country: document.getElementById('salonCountry').value,
                start_date: document.getElementById('salonStartDate').value,
                payment_date: document.getElementById('salonPaymentDate').value,
                tokens_consumed: document.getElementById('salonTokens').value,
                password: document.getElementById('salonPassword').value // NEW
            };

            const res = await apiPost('/admin/salones', data);
            if (res.success) {
                alert('Sal贸n Creado');
                closeSalonModal();
                e.target.reset();
                loadSalons();
            } else {
                alert('Error: ' + res.error);
            }
        });

        async function deleteSalon(id) {
            if (confirm('驴Eliminar sal贸n? Esta acci贸n es irreversible.')) {
                const res = await apiDelete(`/admin/salones/${id}`);
                if (res.success) loadSalons();
                else alert(res.error);
            }
        }

        async function deleteUser(id) {
            console.log('deleteUser llamado con ID:', id);
            if (confirm('驴Eliminar usuario? Esta acci贸n es irreversible y eliminar谩 todos sus datos.')) {
                const res = await apiDelete(`/admin/usuarios/${id}`);
                console.log('Respuesta del servidor:', res);
                if (res.success) loadUsers();
                else alert(res.error);
            }
        }

        async function loadPendingComments() {
            const container = document.getElementById('commentsContainer');
            const res = await apiGet('/admin/comentarios/pendientes'); // Mock endpoint path
            if (res.success && res.data.comments?.length > 0) {
                container.innerHTML = res.data.comments.map(c => `<div class="p-4 border">Comentario: ${c.content}</div>`).join('');
            } else { container.innerHTML = '<p class="text-gray-400 text-center">No hay comentarios</p>'; }
        }

        async function loadPendingTransactions() {
            const container = document.getElementById('transactionsContainer');
            container.innerHTML = '<p class="text-gray-400 text-center">No hay transacciones pendientes</p>';
        }

        async function loadSpecialties() {
            const container = document.getElementById('specialtiesList');
            const res = await apiGet('/admin/especialidades');
            if (res.success && res.data.specialties) {
                container.innerHTML = res.data.specialties.map(s => `
                    <div class="flex justify-between p-2 bg-gray-50 rounded border">
                        <span>${s.name}</span>
                        <button onclick="apiDelete('/admin/especialidades/${s.id}').then(loadSpecialties)" class="text-red-500">X</button>
                    </div>`).join('');
            }
        }

        // Search Logic
        let searchTimeout;
        function handleSearch(e) {
            clearTimeout(searchTimeout);
            const query = e.target.value;
            const results = document.getElementById('searchResults');
            if (query.length < 2) { results.classList.add('hidden'); return; }

            searchTimeout = setTimeout(async () => {
                const res = await apiGet(`/admin/profesionales/buscar?q=${encodeURIComponent(query)}`);
                if (res.success && res.data.professionals.length > 0) {
                    results.innerHTML = res.data.professionals.map(p => `
                        <div onclick="selectProfessional(${p.id}, '${p.full_name}')" class="p-3 hover:bg-blue-50 cursor-pointer border-b">
                            <p class="font-bold">${p.full_name}</p>
                            <p class="text-xs text-gray-500">${p.email}</p>
                        </div>
                     `).join('');
                    results.classList.remove('hidden');
                } else {
                    results.innerHTML = '<div class="p-3 text-gray-400">No encontrado</div>';
                    results.classList.remove('hidden');
                }
            }, 300);
        }

        function selectProfessional(id, name) {
            document.getElementById('professionalId').value = id;
            document.getElementById('selectedProfessionalName').textContent = name;
            document.getElementById('searchResults').classList.add('hidden');
            document.getElementById('searchProfessional').value = '';
        }

        document.getElementById('creditsForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('professionalId').value;
            const res = await apiPost(`/admin/creditos/${id}`, {
                amount: document.getElementById('creditAmount').value,
                reason: document.getElementById('creditReason').value
            });
            if (res.success) { alert('Cr茅ditos Agregados'); e.target.reset(); document.getElementById('selectedProfessionalName').textContent = ''; }
            else { alert('Error: ' + res.error); }
        });

    </script>
</body>

</html>